name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1"

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  cargo-audit:
    name: Cargo Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo install cargo-audit
      - run: cargo audit
        env:
          CARGO_AUDIT_FETCH_TIMEOUT: 120

  trivy:
    name: Trivy Image Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: ai-proxy:scan
          cache-from: type=gha

      - uses: aquasecurity/trivy-action@master
        with:
          image-ref: ai-proxy:scan
          format: table
          exit-code: "1"
          ignore-unfixed: true
          severity: CRITICAL,HIGH
